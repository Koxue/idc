<?php  function mysql_ConfigOptions() { $configarray = array( "PHPMYADMIN地址" => array("Type" => "text", "Description" => "可为空,完整地址带http://") ); return $configarray; } function mysql_conn($OSWAP_f45d8cfa11133a81ad3b0edb4d491426,&$con){ if ($OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverhostname"]) { $OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverdomain"] = $OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverhostname"]; } else { $OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverdomain"] = $OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverip"]; } if(empty($OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverport"])) $OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverport"]=3306; $con = new mysqli($OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverdomain"],$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverusername"],$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverpassword"],$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serverport"]); if($con->connect_errno){ return false; } return true; } function mysql_CreateAccount($OSWAP_f45d8cfa11133a81ad3b0edb4d491426) { $con = ''; if(!mysql_conn($OSWAP_f45d8cfa11133a81ad3b0edb4d491426,$con)) return('不能连接数据库: ' . $con->OSWAP_b2846c78a3dcf370a1b640174872b165); $OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]=time(); update_query("服务",array("用户名"=>$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]),array("id"=> $OSWAP_f45d8cfa11133a81ad3b0edb4d491426["serviceid"])); $OSWAP_affd132a904ad83929ec1bdd1f77f14d = $con->query("SELECT * FROM mysql.user WHERE User='".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."'"); if(mysqli_num_rows($OSWAP_affd132a904ad83929ec1bdd1f77f14d)!=0) return('数据库用户已经存在'); if(!$con->query("CREATE DATABASE `".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."`")){ $OSWAP_bd7acaebc5d2a11e74d4445fdf775273=$con->connect_errno; if($OSWAP_bd7acaebc5d2a11e74d4445fdf775273=='1007') return('数据库已经存在'); else if($OSWAP_bd7acaebc5d2a11e74d4445fdf775273=='1006') return('数据库创建失败： '.$con->OSWAP_b2846c78a3dcf370a1b640174872b165); else return('数据库创建失败,发生未知错误： '.$con->OSWAP_b2846c78a3dcf370a1b640174872b165); } if(!$con->query("insert into mysql.user(Host,User,Password) values('%','".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."',password('".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["password"]."'))")){ return('创建用户失败： '.$con->OSWAP_b2846c78a3dcf370a1b640174872b165); } $con->query("flush privileges"); if(!$con->query("GRANT ALL PRIVILEGES ON `".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."`.* to '".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."'@'%'")){ return('用户绑定数据库失败： '.$con->OSWAP_b2846c78a3dcf370a1b640174872b165); } $con->query("flush privileges"); mysqli_close($con); return "成功"; } function mysql_TerminateAccount($OSWAP_f45d8cfa11133a81ad3b0edb4d491426) { $con = ''; if(!mysql_conn($OSWAP_f45d8cfa11133a81ad3b0edb4d491426,$con)) return('不能连接数据库: ' . $con->OSWAP_b2846c78a3dcf370a1b640174872b165); $OSWAP_affd132a904ad83929ec1bdd1f77f14d = $con->query("SELECT * FROM mysql.user WHERE User='".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."'"); if(mysqli_num_rows($OSWAP_affd132a904ad83929ec1bdd1f77f14d)==0) return('成功'); if(!$con->query("DELETE FROM mysql.user WHERE User='".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."'")){ return('删除用户失败： '.$con->OSWAP_b2846c78a3dcf370a1b640174872b165); } if(!$con->query("drop database `".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."`")){ return('数据库删除失败： '.$con->OSWAP_b2846c78a3dcf370a1b640174872b165); } $con->query("flush privileges"); mysqli_close($con); return "成功"; } function mysql_SuspendAccount($OSWAP_f45d8cfa11133a81ad3b0edb4d491426) { $con = ''; if(!mysql_conn($OSWAP_f45d8cfa11133a81ad3b0edb4d491426,$con)) return('不能连接数据库: ' . $con->OSWAP_b2846c78a3dcf370a1b640174872b165); if(!$con->query("revoke all privileges on `".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."`.* from '".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."'@'%'")){ return('用户绑定数据库失败： '.$con->OSWAP_b2846c78a3dcf370a1b640174872b165); } $con->query("flush privileges"); mysqli_close($con); return "成功"; } function mysql_UnsuspendAccount($OSWAP_f45d8cfa11133a81ad3b0edb4d491426) { $con = ''; if(!mysql_conn($OSWAP_f45d8cfa11133a81ad3b0edb4d491426,$con)) return('不能连接数据库: ' . $con->OSWAP_b2846c78a3dcf370a1b640174872b165); if(!$con->query("GRANT ALL PRIVILEGES ON `".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."`.* to '".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."'@'%'")){ return('用户绑定数据库失败： '.$con->OSWAP_b2846c78a3dcf370a1b640174872b165); } $con->query("flush privileges"); mysqli_close($con); return "成功"; } function mysql_ChangePassword($OSWAP_f45d8cfa11133a81ad3b0edb4d491426) { $con = ''; if(!mysql_conn($OSWAP_f45d8cfa11133a81ad3b0edb4d491426,$con)) return('不能连接数据库: ' . $con->OSWAP_b2846c78a3dcf370a1b640174872b165); $OSWAP_affd132a904ad83929ec1bdd1f77f14d = $con->query("SELECT * FROM mysql.user WHERE User='".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."'"); if(mysqli_num_rows($OSWAP_affd132a904ad83929ec1bdd1f77f14d)==0) return('不存在的用户'); if(!$con->query("update mysql.user set password=password('".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["password"]."') where User='".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["username"]."'")){ return('删除用户失败： '.$con->OSWAP_b2846c78a3dcf370a1b640174872b165); } $con->query("flush privileges"); mysqli_close($con); return "成功"; } function mysql_ClientArea($OSWAP_f45d8cfa11133a81ad3b0edb4d491426) { $lang=plug_lang_get('mysql','','2'); if(empty($OSWAP_f45d8cfa11133a81ad3b0edb4d491426["configoption1"])) return array($lang['请直接使用帐号密码进行MYSQL登入']); else return array("<a href=\"".$OSWAP_f45d8cfa11133a81ad3b0edb4d491426["configoption1"]."\" target=\"_blank\">登录PHPMYADMIN</a>"); } 