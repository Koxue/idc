<?php  defined('SWAP_ROOT') or die('非法操作'); class swap_buy extends controller { function index(){ $dq=$this->setbuyfl(); $this->setbuycp($dq); TEMPLATE::display('buy.tpl'); } function cart(){ do_temp_plug("购买页面初始化"); define('CPID',mac_url_get(1)); $OSWAP_97a016e66275c6039729b703b9d85f30=CPID; if($OSWAP_97a016e66275c6039729b703b9d85f30=='') exit(redirect($this->cakurl().'/buy/index/?error='.$this->lang['error']['产品id为空'])); session('优惠码价格',null); $this->conn->select('产品','*',"id='".$OSWAP_97a016e66275c6039729b703b9d85f30."'"); if($this->conn->db_num_rows()==0) exit(redirect($this->cakurl().'/buy/index/?error='.$this->lang['error']['无法找到此产品'])); $OSWAP_9a173a393306a25aca4de03b9f1c4e98=$this->conn->fetch_array(); if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['下架']=='1') exit(redirect($this->cakurl().'/buy/index/?warning='.$this->lang['error']['此产品已经下架'])); if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['库存']<=0) exit(redirect($this->cakurl().'/buy/index/?warning='.$this->lang['error']['此产品库存不足'])); $OSWAP_26f5c7e93f11d85a7328be7da0af3019=true; if(strstr($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期'],'[')){ $OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=json_decode($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期'],true); $temp=array(); foreach($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期'] as $OSWAP_6291cc79354613208317e7b10b238055=>$OSWAP_0d07de59261cc2c9023b194184c575fb){ if($OSWAP_0d07de59261cc2c9023b194184c575fb['启用']) $temp[$OSWAP_6291cc79354613208317e7b10b238055]=$OSWAP_0d07de59261cc2c9023b194184c575fb; } $OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=$temp; $OSWAP_26f5c7e93f11d85a7328be7da0af3019=false; } if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['显示域名选项']) $OSWAP_41f7ced2e3a38af3c6ff6d9a282725db=json_decode($OSWAP_9a173a393306a25aca4de03b9f1c4e98['免费域名']); $OSWAP_9047f1ca334c3a4c409830d91f3a9995=ServerFunction(array("moduletype"=>$OSWAP_9a173a393306a25aca4de03b9f1c4e98['面板类型']),'BuyCustom'); if(mac_url_get(2)=='submit'){ if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['只能买一次']) if(!Order::OnlyOne(User::Uid(),CPID)) exit(redirect($this->cakurl().'/control/index/?error='.$this->lang['error']['这个产品只能买一个,请停止目前的产品后再试!'])); if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['允许数量']) if(!Order::AllowNum(User::Uid(),CPID,$OSWAP_9a173a393306a25aca4de03b9f1c4e98['允许数量'])) exit(redirect($this->cakurl().'/control/index/?error='.$this->lang['error']['这个产品只能买'].$OSWAP_9a173a393306a25aca4de03b9f1c4e98['允许数量'].$this->lang['error']['个,请停止目前的产品后再试!'])); if($OSWAP_26f5c7e93f11d85a7328be7da0af3019){ if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']!='一次性'){ $OSWAP_c7ff9a54db2f6defc8cfbefa08395009=round(_POST('days')); if(($OSWAP_c7ff9a54db2f6defc8cfbefa08395009<=0)) exit(redirect($this->cakurl().'/control/index/?error='.$this->lang['rate']['天数错误'])); }else $OSWAP_c7ff9a54db2f6defc8cfbefa08395009=1; $OSWAP_ecd5611555a600e7f5823c5b9e6e1329=$OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']; }else{ $OSWAP_0b9d870f05f7e996c462424f26bae27e=_POST('cycleid'); if(!isset($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期'][$OSWAP_0b9d870f05f7e996c462424f26bae27e])) exit(redirect($this->cakurl().'/control/index/?error='.$this->lang['error']['不存在的周期'])); $OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=$OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期'][$OSWAP_0b9d870f05f7e996c462424f26bae27e]; $OSWAP_ecd5611555a600e7f5823c5b9e6e1329=$OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']['名称']; $OSWAP_9a173a393306a25aca4de03b9f1c4e98['价格']=$OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']['价格']; $OSWAP_9a173a393306a25aca4de03b9f1c4e98['开通方式']=$OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']['自动']?'自动开通':'审核开通'; $OSWAP_c7ff9a54db2f6defc8cfbefa08395009=$OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']['时间']; } if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['隐藏域名配置']!='1'){ $OSWAP_6f2c947224eb743d0d130eb9f1f71145=_POST('domainoption'); if($OSWAP_6f2c947224eb743d0d130eb9f1f71145==''){ exit(redirect($this->cakurl().'/buy/cart/'.$OSWAP_97a016e66275c6039729b703b9d85f30.'/')); }else if($OSWAP_6f2c947224eb743d0d130eb9f1f71145=='domain'){ $OSWAP_82bdfee4b92084c05ac3b384dd79c752=_POST('domain'); $OSWAP_33988b2b396086c56007db103c102e94=_POST('domainhz'); }else if($OSWAP_6f2c947224eb743d0d130eb9f1f71145=='freedomain'){ $OSWAP_82bdfee4b92084c05ac3b384dd79c752=_POST('freedomain'); $OSWAP_33988b2b396086c56007db103c102e94=_POST('freedomainhz'); } if(($OSWAP_82bdfee4b92084c05ac3b384dd79c752=='')or($OSWAP_33988b2b396086c56007db103c102e94=='')) exit(redirect($this->cakurl().'/buy/cart/'.$OSWAP_97a016e66275c6039729b703b9d85f30.'/?warning='.$this->lang['error']['请填写需要开通服务的域名!!'])); $OSWAP_6f1c672b832d7b5c6416094a75884aa1=$OSWAP_82bdfee4b92084c05ac3b384dd79c752.'.'.$OSWAP_33988b2b396086c56007db103c102e94; $this->conn->select('服务','*',"域名='".$OSWAP_6f1c672b832d7b5c6416094a75884aa1."' AND 产品id='".$OSWAP_97a016e66275c6039729b703b9d85f30."' AND 状态!='停止'"); if($this->conn->db_num_rows()!=0) exit(redirect($this->cakurl().'/buy/cart/'.$OSWAP_97a016e66275c6039729b703b9d85f30.'/?error='.$this->lang['error']['这个域名在系统里已经存在!!'])); }else $OSWAP_6f1c672b832d7b5c6416094a75884aa1='无需主域名'; $OSWAP_ba9c7fd940d9e3ec87c46a8ce747c4f8=_POST('buyoptions')?_POST('buyoptions'):array(); foreach($OSWAP_ba9c7fd940d9e3ec87c46a8ce747c4f8 as $OSWAP_51d4cad9672e6605c99e0c3d678f456e=>$OSWAP_31bb5897a4cf8155e2d7054f8ef132dd){ if($OSWAP_31bb5897a4cf8155e2d7054f8ef132dd=='') exit(redirect($this->cakurl().'/buy/cart/'.$OSWAP_97a016e66275c6039729b703b9d85f30.'/?error='.$this->lang['error']['产品配置未添全!!'])); } Order::Inventory($OSWAP_97a016e66275c6039729b703b9d85f30); $OSWAP_52f9dec452091441f61b47d651724908=_POST('notes'); $OSWAP_75f9c62048bc984d9256fc12f3670015=Order::Create(User::Uid(),CPID,$OSWAP_9a173a393306a25aca4de03b9f1c4e98['服务器组'],$OSWAP_9a173a393306a25aca4de03b9f1c4e98['类型'],$OSWAP_6f1c672b832d7b5c6416094a75884aa1,is_array($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期'])?json_encode($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']):$OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期'],$OSWAP_52f9dec452091441f61b47d651724908,$OSWAP_c7ff9a54db2f6defc8cfbefa08395009); foreach($OSWAP_ba9c7fd940d9e3ec87c46a8ce747c4f8 as $OSWAP_51d4cad9672e6605c99e0c3d678f456e=>$OSWAP_31bb5897a4cf8155e2d7054f8ef132dd){ $this->conn->insert('主机自定义配置选项',"服务id,名字,内容","'".$OSWAP_75f9c62048bc984d9256fc12f3670015."','".$OSWAP_51d4cad9672e6605c99e0c3d678f456e."','".$OSWAP_31bb5897a4cf8155e2d7054f8ef132dd."'"); } $configpost=_POST('config')?_POST('config'):array(); foreach($configpost as $OSWAP_51d4cad9672e6605c99e0c3d678f456eid=>$OSWAP_31bb5897a4cf8155e2d7054f8ef132dd){ $this->conn->insert('主机配置选项',"服务id,配置id,选项id","'".$OSWAP_75f9c62048bc984d9256fc12f3670015."','".$OSWAP_51d4cad9672e6605c99e0c3d678f456eid."','".$OSWAP_31bb5897a4cf8155e2d7054f8ef132dd."'"); } if($OSWAP_26f5c7e93f11d85a7328be7da0af3019){ if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['价格']=='免费'){ if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=='日付'){ if($OSWAP_c7ff9a54db2f6defc8cfbefa08395009>30) exit(redirect($this->cakurl().'/control/index/?error='.$this->lang['error']['免费产品最多买30天'])); }else if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=='月付'){ if($OSWAP_c7ff9a54db2f6defc8cfbefa08395009!=1) exit(redirect($this->cakurl().'/control/index/?error='.$this->lang['error']['免费产品最多买1个月'])); }else if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=='年付'){ if($OSWAP_c7ff9a54db2f6defc8cfbefa08395009!=1) exit(redirect($this->cakurl().'/control/index/?error='.$this->lang['error']['免费产品最多买1年'])); } } } $OSWAP_feca98aae73a7e04beef319618026dfa=0; $OSWAP_d127cd68f7e59c97652e367d3a6eb780=_POST('promocode'); if($OSWAP_d127cd68f7e59c97652e367d3a6eb780!=''){ $this->conn->select('优惠码表','*',"优惠码='".$OSWAP_d127cd68f7e59c97652e367d3a6eb780."'"); if($this->conn->db_num_rows()!=0){ $OSWAP_2822f7e8a80d473ecff69cdf4b7378d2=$this->conn->fetch_array(); $OSWAP_287a254c9f12cdd910b97c773adb4f3b=time(); if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['开始时间']!='0000-00-00 00:00:00'){ $OSWAP_b33d82f395f5ef712ae68b580dbf13d8=strtotime($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['开始时间']); $OSWAP_cf104113aea177d5d1ff1177185f8b8b=$OSWAP_b33d82f395f5ef712ae68b580dbf13d8-$OSWAP_287a254c9f12cdd910b97c773adb4f3b; if($OSWAP_cf104113aea177d5d1ff1177185f8b8b>0) $OSWAP_feca98aae73a7e04beef319618026dfa++; } if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['到期时间']!='0000-00-00 00:00:00'){ $OSWAP_b8aefb02a820d8893d9f2353e3bd998b=strtotime($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['到期时间']); $OSWAP_cf104113aea177d5d1ff1177185f8b8b=$OSWAP_b8aefb02a820d8893d9f2353e3bd998b-$OSWAP_287a254c9f12cdd910b97c773adb4f3b; if($OSWAP_cf104113aea177d5d1ff1177185f8b8b<0) $OSWAP_feca98aae73a7e04beef319618026dfa++; } if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['最多使用次数']!='0'){ if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['最多使用次数']<=$OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['已经使用次数']) $OSWAP_feca98aae73a7e04beef319618026dfa++; } if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['只能一次']){ $this->conn->select('优惠码日志表','*',"优惠码='".$OSWAP_d127cd68f7e59c97652e367d3a6eb780."' AND uid='".$this->OSWAP_b59487239706386f068f2549a4adfa62."'"); if($this->conn->db_num_rows()!=0) $OSWAP_feca98aae73a7e04beef319618026dfa++; } } }else $OSWAP_feca98aae73a7e04beef319618026dfa=1; if($OSWAP_feca98aae73a7e04beef319618026dfa==0){ if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['类型']=='指定产品'){ if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['适用产品']!=$OSWAP_97a016e66275c6039729b703b9d85f30) exit(redirect($this->cakurl().'/control/index/?warning='.$this->lang['error']['产品下单成功,但由于使用了不适用产品的优惠码导致无法开通!!'])); } } if($OSWAP_26f5c7e93f11d85a7328be7da0af3019){ if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['价格']=='免费') $OSWAP_ae19c156b22bae4ad0694d158f0cddb3=0; else $OSWAP_ae19c156b22bae4ad0694d158f0cddb3=$OSWAP_9a173a393306a25aca4de03b9f1c4e98['价格']; $OSWAP_ae19c156b22bae4ad0694d158f0cddb3=($OSWAP_ae19c156b22bae4ad0694d158f0cddb3*$OSWAP_c7ff9a54db2f6defc8cfbefa08395009); }else{ $OSWAP_ae19c156b22bae4ad0694d158f0cddb3=$OSWAP_9a173a393306a25aca4de03b9f1c4e98['价格']; } if($OSWAP_feca98aae73a7e04beef319618026dfa==0){ if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['价值']>=$OSWAP_ae19c156b22bae4ad0694d158f0cddb3) $OSWAP_64aaf009c819802c1898685c5e146279=1; else $OSWAP_ae19c156b22bae4ad0694d158f0cddb3=($OSWAP_ae19c156b22bae4ad0694d158f0cddb3-$OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['价值']); } if($OSWAP_64aaf009c819802c1898685c5e146279!=1){ if($this->OSWAP_30b31a94e0c5a437f6c1c6006e473bc5['登陆预存款']<$OSWAP_ae19c156b22bae4ad0694d158f0cddb3) exit(redirect($this->cakurl().'/control/index/?warning='.$this->lang['error']['预存款不足,还差'].($OSWAP_ae19c156b22bae4ad0694d158f0cddb3-$this->OSWAP_30b31a94e0c5a437f6c1c6006e473bc5['登陆预存款']).$this->c['交易币名称'])); $this->conn->update('用户',"预存款='".($this->OSWAP_30b31a94e0c5a437f6c1c6006e473bc5['登陆预存款']-$OSWAP_ae19c156b22bae4ad0694d158f0cddb3)."'","uid='".$this->OSWAP_b59487239706386f068f2549a4adfa62."'"); $OSWAP_64aaf009c819802c1898685c5e146279=1; } if($OSWAP_feca98aae73a7e04beef319618026dfa==0){ $this->conn->update('优惠码表',"已经使用次数=已经使用次数+1","优惠码='".$OSWAP_d127cd68f7e59c97652e367d3a6eb780."'"); $this->conn->insert('优惠码日志表','uid,优惠码',"'".$this->OSWAP_b59487239706386f068f2549a4adfa62."','".$OSWAP_d127cd68f7e59c97652e367d3a6eb780."'"); } if($OSWAP_26f5c7e93f11d85a7328be7da0af3019){ if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=='日付'){ $OSWAP_fe7a81a7636f76f8b5ade2206bd80b9eday="+ INTERVAL ".$OSWAP_c7ff9a54db2f6defc8cfbefa08395009." DAY"; }else if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=='月付'){ $OSWAP_fe7a81a7636f76f8b5ade2206bd80b9eday="+ INTERVAL ".$OSWAP_c7ff9a54db2f6defc8cfbefa08395009." MONTH"; }else if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=='年付'){ $OSWAP_fe7a81a7636f76f8b5ade2206bd80b9eday="+ INTERVAL ".$OSWAP_c7ff9a54db2f6defc8cfbefa08395009." YEAR"; }else if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['周期']=='一次性'){ $OSWAP_fe7a81a7636f76f8b5ade2206bd80b9eday=""; } }else{ $OSWAP_fe7a81a7636f76f8b5ade2206bd80b9eday="+ INTERVAL ".$OSWAP_c7ff9a54db2f6defc8cfbefa08395009." DAY"; } $this->conn->update('服务',"开通时间=now(),到期时间=now() ".$OSWAP_fe7a81a7636f76f8b5ade2206bd80b9eday.",状态='等待审核',购买数量='".$OSWAP_c7ff9a54db2f6defc8cfbefa08395009."',优惠码='".$OSWAP_d127cd68f7e59c97652e367d3a6eb780."',开通付费='".$OSWAP_ae19c156b22bae4ad0694d158f0cddb3."'","id='".$OSWAP_75f9c62048bc984d9256fc12f3670015."' AND 帐号id='".$this->OSWAP_b59487239706386f068f2549a4adfa62."'"); if($OSWAP_9a173a393306a25aca4de03b9f1c4e98['开通方式']=='自动开通'){ $OSWAP_93e86675a14bf45114306ac2be631499=ServerCreateAccount($OSWAP_75f9c62048bc984d9256fc12f3670015); if($OSWAP_93e86675a14bf45114306ac2be631499=='成功') exit(redirect($this->cakurl().'/control/index/?success='.$this->lang['error']['开通产品成功!'])); else if($OSWAP_93e86675a14bf45114306ac2be631499=='存在的域名') exit(redirect($this->cakurl().'/control/index/?warning='.$this->lang['error']['您开通的域名已经在系统中存在,请停止后再开通!'])); elseif(strstr($OSWAP_93e86675a14bf45114306ac2be631499,'公开信息:')) exit(redirect($this->cakurl().'/control/index/?warning='.str_replace('公开信息:','',$OSWAP_93e86675a14bf45114306ac2be631499))); else exit(redirect($this->cakurl().'/control/index/?warning='.$this->lang['error']['产品下单成功,但产品配置有问题或者通信问题无法自动开通,请质询管理员!'])); }else exit(redirect($this->cakurl().'/control/index/?success='.$this->lang['error']['请管理员等待审核开通!'])); } $this->conn->select('产品配置连接','组id',"产品id='".$OSWAP_97a016e66275c6039729b703b9d85f30."'"); $OSWAP_496784ccf91ae3a683b1444107f1e392=array(); while($OSWAP_51d4cad9672e6605c99e0c3d678f456e = $this->conn->fetch_assoc()){ $OSWAP_496784ccf91ae3a683b1444107f1e392[]=$OSWAP_51d4cad9672e6605c99e0c3d678f456e; } $OSWAP_2ffeee53ec6eab6273dbc15ca8e3e33d=array(); $OSWAP_677795dfa65f9e91b8a36d13a0bcaf6b=array(); foreach($OSWAP_496784ccf91ae3a683b1444107f1e392 as $OSWAP_51d4cad9672e6605c99e0c3d678f456es){ $this->conn->select('产品配置选项','*',"组id='".$OSWAP_51d4cad9672e6605c99e0c3d678f456es['组id']."'"); while($OSWAP_51d4cad9672e6605c99e0c3d678f456e = $this->conn->fetch_assoc()){ $OSWAP_677795dfa65f9e91b8a36d13a0bcaf6b[]=$OSWAP_51d4cad9672e6605c99e0c3d678f456e; $OSWAP_2ffeee53ec6eab6273dbc15ca8e3e33d[$OSWAP_51d4cad9672e6605c99e0c3d678f456e['id']]['id']=$OSWAP_51d4cad9672e6605c99e0c3d678f456e['id']; $OSWAP_2ffeee53ec6eab6273dbc15ca8e3e33d[$OSWAP_51d4cad9672e6605c99e0c3d678f456e['id']]['名称']=$OSWAP_51d4cad9672e6605c99e0c3d678f456e['选项名称']; } } foreach($OSWAP_677795dfa65f9e91b8a36d13a0bcaf6b as $OSWAP_51d4cad9672e6605c99e0c3d678f456es){ $this->conn->select('产品配置选项名称','*',"配置id='".$OSWAP_51d4cad9672e6605c99e0c3d678f456es['id']."'"); while($OSWAP_51d4cad9672e6605c99e0c3d678f456ess = $this->conn->fetch_assoc()){ $tempname[$OSWAP_51d4cad9672e6605c99e0c3d678f456ess['id']]=array('id'=>$OSWAP_51d4cad9672e6605c99e0c3d678f456ess['id'],'名称'=>$OSWAP_51d4cad9672e6605c99e0c3d678f456ess['选项名称']); } $OSWAP_2ffeee53ec6eab6273dbc15ca8e3e33d[$OSWAP_51d4cad9672e6605c99e0c3d678f456es['id']]['选项']=$tempname; unset($tempname); } TEMPLATE::assign('options',$OSWAP_2ffeee53ec6eab6273dbc15ca8e3e33d); TEMPLATE::assign('buyoptions',$OSWAP_9047f1ca334c3a4c409830d91f3a9995); TEMPLATE::assign('freedomains',$OSWAP_41f7ced2e3a38af3c6ff6d9a282725db); TEMPLATE::assign('cart',$OSWAP_9a173a393306a25aca4de03b9f1c4e98); TEMPLATE::display('cart.tpl'); } function promo(){ $OSWAP_d127cd68f7e59c97652e367d3a6eb780=_POST('swap'); if($OSWAP_d127cd68f7e59c97652e367d3a6eb780=='') die($this->lang['promo']['优惠码为空,重试']); $this->conn->select('优惠码表','*',"优惠码='".$OSWAP_d127cd68f7e59c97652e367d3a6eb780."'"); if($this->conn->db_num_rows()==0) die($this->lang['promo']['不存在的优惠码,重试']); $OSWAP_2822f7e8a80d473ecff69cdf4b7378d2=$this->conn->fetch_array(); $OSWAP_287a254c9f12cdd910b97c773adb4f3b=time(); if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['开始时间']!='0000-00-00 00:00:00'){ $OSWAP_b33d82f395f5ef712ae68b580dbf13d8=strtotime($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['开始时间']); $OSWAP_cf104113aea177d5d1ff1177185f8b8b=$OSWAP_b33d82f395f5ef712ae68b580dbf13d8-$OSWAP_287a254c9f12cdd910b97c773adb4f3b; if($OSWAP_cf104113aea177d5d1ff1177185f8b8b>0) die($this->lang['promo']['优惠码未到开始时间,重试']); } if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['到期时间']!='0000-00-00 00:00:00'){ $OSWAP_b8aefb02a820d8893d9f2353e3bd998b=strtotime($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['到期时间']); $OSWAP_cf104113aea177d5d1ff1177185f8b8b=$OSWAP_b8aefb02a820d8893d9f2353e3bd998b-$OSWAP_287a254c9f12cdd910b97c773adb4f3b; if($OSWAP_cf104113aea177d5d1ff1177185f8b8b<0) die($this->lang['promo']['优惠码已经过期,重试']); } if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['最多使用次数']!='0'){ if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['最多使用次数']<=$OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['已经使用次数']) die($this->lang['promo']['优惠码超过最多使用次数,重试']); } if($OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['只能一次']){ $this->conn->select('优惠码日志表','*',"优惠码='".$OSWAP_d127cd68f7e59c97652e367d3a6eb780."' AND uid='".$this->OSWAP_b59487239706386f068f2549a4adfa62."'"); if($this->conn->db_num_rows()!=0) die($this->lang['promo']['优惠码只能使用一次,重试']); } session('优惠码价格',$OSWAP_2822f7e8a80d473ecff69cdf4b7378d2['价值']); die('ok'); } function rate(){ $OSWAP_908db77da9e7287c111a015511c3845a=_POST('cartid'); $OSWAP_c7ff9a54db2f6defc8cfbefa08395009=_POST('days'); $OSWAP_c7ff9a54db2f6defc8cfbefa08395009=round($OSWAP_c7ff9a54db2f6defc8cfbefa08395009); if($OSWAP_908db77da9e7287c111a015511c3845a=='') die($this->lang['rate']['产品ID为空无法计算']); if($OSWAP_c7ff9a54db2f6defc8cfbefa08395009=='') die($this->lang['rate']['天数为空']); $this->conn->select('产品','*',"id='".$OSWAP_908db77da9e7287c111a015511c3845a."'"); if($this->conn->db_num_rows()==0) die($this->lang['rate']['没有找到产品']); $OSWAP_4b6631bcefdfc345bd99b75ed1204c7a=$this->conn->fetch_array(); if($OSWAP_c7ff9a54db2f6defc8cfbefa08395009<=0) die($this->lang['rate']['天数错误']); if($OSWAP_4b6631bcefdfc345bd99b75ed1204c7a['价格']=='免费'){ if($OSWAP_4b6631bcefdfc345bd99b75ed1204c7a['周期']=='日付'){ if($OSWAP_c7ff9a54db2f6defc8cfbefa08395009>30) die($this->lang['rate']['免费产品最多买30天']); }else if($OSWAP_4b6631bcefdfc345bd99b75ed1204c7a['周期']=='月付'){ if($OSWAP_c7ff9a54db2f6defc8cfbefa08395009!=1) die($this->lang['rate']['免费产品最多买1个月']); }else if($OSWAP_4b6631bcefdfc345bd99b75ed1204c7a['周期']=='年付'){ if($OSWAP_c7ff9a54db2f6defc8cfbefa08395009!=1) die($this->lang['rate']['免费产品最多买1年']); } die('0.00'); } $OSWAP_40145be0d7ec03c8d07d1f6548dd9ea1=session('优惠码价格'); $OSWAP_735586c4439ebc2b9e0107bc94ad4fb5=($OSWAP_4b6631bcefdfc345bd99b75ed1204c7a['价格']*$OSWAP_c7ff9a54db2f6defc8cfbefa08395009)-(float)$OSWAP_40145be0d7ec03c8d07d1f6548dd9ea1; die($OSWAP_735586c4439ebc2b9e0107bc94ad4fb5); } } 