<?php  defined('SWAP_ROOT') or die('非法操作'); class swap_index extends controller { function index(){ $this->news(7); TEMPLATE::display('index.tpl'); } function announcements(){ $this->news(); TEMPLATE::display('announcements.tpl'); } function announcement(){ $id=mac_url_get(1); $this->anew($id); TEMPLATE::display('announcement.tpl'); } function login(){ $this->cleanlogin(); $this->cakelogin(); do_temp_plug('登入页底部'); TEMPLATE::display('login.tpl'); } function register(){ $OSWAP_30b31a94e0c5a437f6c1c6006e473bc5name=_POST('username'); if($OSWAP_30b31a94e0c5a437f6c1c6006e473bc5name!=''){ $OSWAP_c9d58e6756676f02d347c255bcb6b03b=_POST('password'); $OSWAP_71fd491bc9e028bf3f050c23794fbd6e=_POST('repassword'); $OSWAP_4a6f164ef3c908fa9e5fd8ffecc9b706=_POST('email'); $OSWAP_0d07de59261cc2c9023b194184c575fb=_POST('name'); $OSWAP_d23519cda7160577a488cef431673b7a=_POST('country'); $OSWAP_a3372a91a0ca1a8b1b4a38ebbeae2626=_POST('address'); $OSWAP_fd2ddfc99bfc05fd289c609c388b789c=_POST('zip'); $OSWAP_75c050f7985c2db293354c2bc1ed86c9=_POST('phone'); if(!$this->IsUsername($OSWAP_30b31a94e0c5a437f6c1c6006e473bc5name)){ exit(redirect($this->cakurl().'/index/register/?warning='.$this->lang['register']['用户名格式不正确'])); } if(!$this->IsUsername($OSWAP_c9d58e6756676f02d347c255bcb6b03b)){ exit(redirect($this->cakurl().'/index/register/?warning='.$this->lang['register']['密码格式不正确'])); } if(!$this->IsSame($OSWAP_c9d58e6756676f02d347c255bcb6b03b,$OSWAP_71fd491bc9e028bf3f050c23794fbd6e)){ exit(redirect($this->cakurl().'/index/register/?warning='.$this->lang['register']['2次密码不一样'])); } if(!$this->IsMail($OSWAP_4a6f164ef3c908fa9e5fd8ffecc9b706)){ exit(redirect($this->cakurl().'/index/register/?warning='.$this->lang['register']['邮箱格式错误'])); } if(($OSWAP_0d07de59261cc2c9023b194184c575fb=='')or($OSWAP_d23519cda7160577a488cef431673b7a=='')or($OSWAP_a3372a91a0ca1a8b1b4a38ebbeae2626=='')or($OSWAP_fd2ddfc99bfc05fd289c609c388b789c=='')or($OSWAP_75c050f7985c2db293354c2bc1ed86c9=='')){ exit(redirect($this->cakurl().'/index/register/?warning='.$this->lang['register']['信息填写不全'])); } $this->conn->select('用户','*',"用户名='$OSWAP_30b31a94e0c5a437f6c1c6006e473bc5name'"); if($this->conn->db_num_rows()!=0){ exit(redirect($this->cakurl().'/index/register/?warning='.$this->lang['register']['用户名已经存在'])); } $this->conn->select('用户','*',"电子邮件='$OSWAP_4a6f164ef3c908fa9e5fd8ffecc9b706'"); if($this->conn->db_num_rows()!=0){ exit(redirect($this->cakurl().'/index/register/?warning='.$this->lang['register']['邮箱已经存在'])); } $OSWAP_0bead33f7592a3ca9198c6e1c2770086=0; $OSWAP_370f31b9805fc6b03f4b1d80d45beb1e=0; $OSWAP_34e586cc7bb553e80825dca411139134=array( 'url'=>'/index/login/', 'color'=>'success', 'text'=>$this->lang['register']['注册成功'] ); do_swap_plug('注册判断',$OSWAP_30b31a94e0c5a437f6c1c6006e473bc5name,$OSWAP_c9d58e6756676f02d347c255bcb6b03b,$OSWAP_0d07de59261cc2c9023b194184c575fb,$OSWAP_d23519cda7160577a488cef431673b7a,$OSWAP_a3372a91a0ca1a8b1b4a38ebbeae2626,$OSWAP_fd2ddfc99bfc05fd289c609c388b789c,$OSWAP_75c050f7985c2db293354c2bc1ed86c9,$OSWAP_4a6f164ef3c908fa9e5fd8ffecc9b706,$OSWAP_0bead33f7592a3ca9198c6e1c2770086,$OSWAP_370f31b9805fc6b03f4b1d80d45beb1e); $this->conn->insert('用户','用户名,密码,姓名,国家,地址,邮编,电话号码,电子邮件,注册时间,预存款,禁止',"'$OSWAP_30b31a94e0c5a437f6c1c6006e473bc5name','".md5('swap'.$OSWAP_c9d58e6756676f02d347c255bcb6b03b)."','$OSWAP_0d07de59261cc2c9023b194184c575fb','$OSWAP_d23519cda7160577a488cef431673b7a','$OSWAP_a3372a91a0ca1a8b1b4a38ebbeae2626','$OSWAP_fd2ddfc99bfc05fd289c609c388b789c','$OSWAP_75c050f7985c2db293354c2bc1ed86c9','$OSWAP_4a6f164ef3c908fa9e5fd8ffecc9b706',now(),'$OSWAP_0bead33f7592a3ca9198c6e1c2770086','$OSWAP_370f31b9805fc6b03f4b1d80d45beb1e'"); do_swap_plug('注册成功',$OSWAP_30b31a94e0c5a437f6c1c6006e473bc5name,$OSWAP_c9d58e6756676f02d347c255bcb6b03b,$OSWAP_0d07de59261cc2c9023b194184c575fb,$OSWAP_d23519cda7160577a488cef431673b7a,$OSWAP_a3372a91a0ca1a8b1b4a38ebbeae2626,$OSWAP_fd2ddfc99bfc05fd289c609c388b789c,$OSWAP_75c050f7985c2db293354c2bc1ed86c9,$OSWAP_4a6f164ef3c908fa9e5fd8ffecc9b706,$OSWAP_0bead33f7592a3ca9198c6e1c2770086,$OSWAP_34e586cc7bb553e80825dca411139134); exit(header('Location: ' . $this->cakurl().$OSWAP_34e586cc7bb553e80825dca411139134['url'].'?'.$OSWAP_34e586cc7bb553e80825dca411139134['color'].'='.urlencode($OSWAP_34e586cc7bb553e80825dca411139134['text']))); } TEMPLATE::display('register.tpl'); } function cron(){ ignore_user_abort(); @ini_set( "memory_limit", "512M" ); @ini_set( "max_execution_time", 0 ); @set_time_limit(0); $GLOBALS['incron']=true; header("Keep-Alive: timeout=5, max=100"); $this->conn->select('系统配置'); $c=$this->conn->fetch_array(); if($c['cron执行完成']=='2' and plug_eva('系统配置','缓存清除时间')==date("Ymd")) $OSWAP_73064d8a7453077a8003ec29c4bcc3ca=2; else $OSWAP_73064d8a7453077a8003ec29c4bcc3ca=1; $this->conn->update('系统配置','cron最后执行时间=now(),cron执行完成=0','1'); do_swap_plug('CRON前'); $this->conn->delete('服务',"状态='停止' and NOW() >=  (到期时间 + INTERVAL ".$c['停止列表清除时间']." DAY)"); $this->conn->delete('服务',"状态='等待付款' and NOW() >=  (到期时间 + INTERVAL ".$c['待付款列表清除时间']." DAY)"); $this->conn->delete('服务',"状态='驳回' and NOW() >=  (到期时间 + INTERVAL ".$c['停止列表清除时间']." DAY)"); if($c['启动暂停']){ $this->conn->select('服务','*',"周期!='一次性' and 状态='激活' and NOW() >=  (到期时间 + INTERVAL ".$c['暂停时间']." DAY)"); $OSWAP_8f70fff0ec4ac96a5a078d55874a38a7=array(); while($OSWAP_51d4cad9672e6605c99e0c3d678f456e = $this->conn->fetch_assoc()){ $OSWAP_8f70fff0ec4ac96a5a078d55874a38a7[] = $OSWAP_51d4cad9672e6605c99e0c3d678f456e['id']; } foreach($OSWAP_8f70fff0ec4ac96a5a078d55874a38a7 as $id){ update_query( "服务", array( "cron正常" => "0" ), array( "id" =>$id)); $OSWAP_b7da14f6d30a57d6556466c8bacc5350result = ServerSuspendAccount($id,"产品已经到期!"); @ini_set( "memory_limit", "512M" ); @ini_set( "max_execution_time", 0 ); @set_time_limit(0); update_query( "服务", array( "cron正常" => "1" ), array( "id" =>$id)); } } if($c['启动删除']){ $this->conn->select('服务','*',"周期!='一次性' and (状态='激活' or 状态='暂停') and NOW() >=  (到期时间 + INTERVAL ".$c['删除时间']." DAY)"); $OSWAP_8f70fff0ec4ac96a5a078d55874a38a7=array(); while($OSWAP_51d4cad9672e6605c99e0c3d678f456e = $this->conn->fetch_assoc()){ $OSWAP_8f70fff0ec4ac96a5a078d55874a38a7[] = $OSWAP_51d4cad9672e6605c99e0c3d678f456e['id']; } foreach($OSWAP_8f70fff0ec4ac96a5a078d55874a38a7 as $id){ update_query( "服务", array( "cron正常" => "0" ), array( "id" =>$id)); $OSWAP_b7da14f6d30a57d6556466c8bacc5350result = ServerTerminateAccount($id); @ini_set( "memory_limit", "512M" ); @ini_set( "max_execution_time", 0 ); @set_time_limit(0); update_query( "服务", array( "cron正常" => "1" ), array( "id" =>$id)); } } do_swap_plug('CRON后'); if(!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') $this->conn->update('系统配置','cron执行完成=2','1'); else $this->conn->update('系统配置','cron执行完成='.$OSWAP_73064d8a7453077a8003ec29c4bcc3ca,'1'); if(plug_eva('系统配置','缓存清除时间')!=date("Ymd")){ import("swap.File"); File::del_dir(SWAP_CACHE); File::mk_dir(SWAP_CACHE); plug_eva('系统配置','缓存清除时间',date("Ymd")); } ServerUsageUpdate(); die('SWAPIDC CRON OK!'); } function version(){ die(VERSION); } } 