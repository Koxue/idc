<?php  defined('SWAP_ROOT') or die('非法操作'); function qqlogin_config(){ $config['swap_plug']='QQ互联'; $config['swap_plug_version']='1.0'; $config['swap_plug_explain']=''; $config['swap_plug_author']='施健'; $config['swap_plug_website']=''; return $config; } function qqlogin_template(){ TEMPLATE::assign('L', qqlogin_lang()); TEMPLATE::display(SWAP_XT. 'swap_plugins'.SWAP_DIR_END.'qqlogin'.SWAP_DIR_END.'templates'.SWAP_DIR_END.'login.tpl'); } add_swap_plug('登入页底部','qqlogin_template'); function qqlogin_head(){ $OSWAP_ab4e5855d192701bed1f687a7bfa73c2=plug_eva('qqlogin','验证标签'); if($OSWAP_ab4e5855d192701bed1f687a7bfa73c2!='') echo '<meta property="qc:admins" content="'.$OSWAP_ab4e5855d192701bed1f687a7bfa73c2.'" />'; $OSWAP_3e3bced9b8337ff0d207516603712130=session("qqlogin_info"); TEMPLATE::assign('qqlogin_info',$OSWAP_3e3bced9b8337ff0d207516603712130); } add_swap_plug('HEAD区域','qqlogin_head'); function qqlogin_userlist(){ TEMPLATE::assign('L', qqlogin_lang()); TEMPLATE::display(SWAP_XT. 'swap_plugins'.SWAP_DIR_END.'qqlogin'.SWAP_DIR_END.'templates'.SWAP_DIR_END.'userlist.tpl'); } function qqlogin_lang($OSWAP_0d911cb1c8544af24bb2fe3d7a06167e=''){ $c=TEMPLATE::assign('c'); $OSWAP_99a2c008efe39fdc17b666c69e1f7d1c=$c['伪静态开关']; if($OSWAP_99a2c008efe39fdc17b666c69e1f7d1c!="0"){ $OSWAP_99a2c008efe39fdc17b666c69e1f7d1c=""; }else{ $OSWAP_99a2c008efe39fdc17b666c69e1f7d1c="/index.php"; } $lang=plug_lang_get('qqlogin','main'); $lang["qqlogin_info"]=session("qqlogin_info"); $lang["伪静态"]=$OSWAP_99a2c008efe39fdc17b666c69e1f7d1c; $lang["referer"]=urlencode(_GET('referer')); if($OSWAP_0d911cb1c8544af24bb2fe3d7a06167e=='')return $lang; if($lang[$OSWAP_0d911cb1c8544af24bb2fe3d7a06167e]!='')return $lang[$OSWAP_0d911cb1c8544af24bb2fe3d7a06167e]; return $OSWAP_0d911cb1c8544af24bb2fe3d7a06167e; } function qqlogin_huidiao($OSWAP_0d911cb1c8544af24bb2fe3d7a06167e){ $ht='http://'; if (is_ssl()) {$ht='https://';} return $ht.$_SERVER['HTTP_HOST']."/index.php/plugin/qqlogin/callback/{$OSWAP_0d911cb1c8544af24bb2fe3d7a06167e}/"; } add_swap_plug('用户页面列表','qqlogin_userlist'); function qqlogin_adminlb(&$OSWAP_68ae843b62f01af97e1cd42eae34b7f6){ $OSWAP_68ae843b62f01af97e1cd42eae34b7f6[]=array('name'=>'QQ互联设置','link'=>'/index.php/plugin/qqlogin/admin/'); } add_swap_plug('管理员菜单列表','qqlogin_adminlb'); class qcl { public function qq_login($OSWAP_22d988d633ec48f840ed54a7f775194c){ $OSWAP_eceb2ff44d5586c248ce90ca6d44f55e = md5(uniqid(rand(), TRUE)); session('state',$OSWAP_eceb2ff44d5586c248ce90ca6d44f55e); $OSWAP_5c4d3a210bd7041f1c603d8fed80b3b5 = array( "response_type"=>"code", "client_id"=>plug_eva("qqlogin","应用id"), "redirect_uri"=>qqlogin_huidiao($OSWAP_22d988d633ec48f840ed54a7f775194c), "client_secret"=>plug_eva("qqlogin","应用Key"), "state"=>$OSWAP_eceb2ff44d5586c248ce90ca6d44f55e, "scope"=>"get_user_info" ); $OSWAP_2674376b4e671d142a52dda291427e0f="https://graph.qq.com/oauth2.0/authorize?".http_build_query($OSWAP_5c4d3a210bd7041f1c603d8fed80b3b5); header("Location:{$OSWAP_2674376b4e671d142a52dda291427e0f}"); die("<p>{$OSWAP_2674376b4e671d142a52dda291427e0f}</p>"); } public function get_openid($OSWAP_22d988d633ec48f840ed54a7f775194c){ $OSWAP_eceb2ff44d5586c248ce90ca6d44f55e = session("state"); if(_GET("state")!= $OSWAP_eceb2ff44d5586c248ce90ca6d44f55e){ die("非法请求"); } $OSWAP_5c4d3a210bd7041f1c603d8fed80b3b5 = array( "grant_type"=>"authorization_code", "client_id"=>plug_eva("qqlogin","应用id"), "redirect_uri"=>qqlogin_huidiao($OSWAP_22d988d633ec48f840ed54a7f775194c), "client_secret"=>plug_eva("qqlogin","应用Key"), "code"=>_GET("code") ); $OSWAP_871421fc8f33da3854b88572cc1b929d = self::g("https://graph.qq.com/oauth2.0/token?".http_build_query($OSWAP_5c4d3a210bd7041f1c603d8fed80b3b5)); $OSWAP_c78da29f8a56fd7bc3cb864388c8822a = json_decode($OSWAP_871421fc8f33da3854b88572cc1b929d,1); if(isset($OSWAP_c78da29f8a56fd7bc3cb864388c8822a['error'])){die($OSWAP_c78da29f8a56fd7bc3cb864388c8822a['error'].$OSWAP_c78da29f8a56fd7bc3cb864388c8822a['error_description']);} $p=array(); parse_str($OSWAP_871421fc8f33da3854b88572cc1b929d, $p); $OSWAP_6c7f029dff5ea7ecc9ba023451612e77 = json_decode(self::g("https://graph.qq.com/oauth2.0/me?access_token={$p["access_token"]}"),1); $OSWAP_3e3bced9b8337ff0d207516603712130 = json_decode(self::g("https://graph.qq.com/user/get_user_info?access_token={$p['access_token']}&oauth_consumer_key={$OSWAP_6c7f029dff5ea7ecc9ba023451612e77['client_id']}&openid={$OSWAP_6c7f029dff5ea7ecc9ba023451612e77['openid']}"),1); $OSWAP_3e3bced9b8337ff0d207516603712130["头像"]=empty($OSWAP_3e3bced9b8337ff0d207516603712130["figureurl_qq_2"]) ? $OSWAP_3e3bced9b8337ff0d207516603712130["figureurl_qq_1"] : $OSWAP_3e3bced9b8337ff0d207516603712130["figureurl_qq_2"] ; $OSWAP_3e3bced9b8337ff0d207516603712130["昵称"]=$OSWAP_3e3bced9b8337ff0d207516603712130["nickname"]; session("qqlogin_info",$OSWAP_3e3bced9b8337ff0d207516603712130); return $OSWAP_6c7f029dff5ea7ecc9ba023451612e77['openid']; } public function g($OSWAP_debdf55f1292a5ad6646e253c5c22486){ $OSWAP_871421fc8f33da3854b88572cc1b929d = file_get_contents($OSWAP_debdf55f1292a5ad6646e253c5c22486); if(empty($OSWAP_871421fc8f33da3854b88572cc1b929d)){ $ch = curl_init(); curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE); curl_setopt($ch, CURLOPT_URL, $OSWAP_debdf55f1292a5ad6646e253c5c22486); $OSWAP_871421fc8f33da3854b88572cc1b929d = curl_exec($ch); curl_close ($ch); } if(empty($OSWAP_871421fc8f33da3854b88572cc1b929d)){$OSWAP_871421fc8f33da3854b88572cc1b929d.='error[50001]';} if(strpos($OSWAP_871421fc8f33da3854b88572cc1b929d, "callback") !== false){$OSWAP_b1ddc361c251c853940e8db5d0985cba = strpos($OSWAP_871421fc8f33da3854b88572cc1b929d, "(");$OSWAP_a2492c443c05b8295feaeaa2b0893221 = strrpos($OSWAP_871421fc8f33da3854b88572cc1b929d, ")");$OSWAP_871421fc8f33da3854b88572cc1b929d = substr($OSWAP_871421fc8f33da3854b88572cc1b929d, $OSWAP_b1ddc361c251c853940e8db5d0985cba + 1, $OSWAP_a2492c443c05b8295feaeaa2b0893221 - $OSWAP_b1ddc361c251c853940e8db5d0985cba -1);} return $OSWAP_871421fc8f33da3854b88572cc1b929d; } }