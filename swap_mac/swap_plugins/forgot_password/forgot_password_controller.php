<?php  defined('SWAP_ROOT') or die('非法操作'); function forgot_password_read() { import("swap.Mail"); } function forgot_password_randStr($OSWAP_e0b3d440dafc9f523938cdfe17957143=6) { $OSWAP_e264d1bce6a5ee7fb97f45d68258bdfe='ABDEFGHJKLMNPQRSTVWXYabdefghijkmnpqrstvwxy23456789'; mt_srand((double)microtime()*1000000*getmypid()); $OSWAP_a2d97d347e702f4333fb5dd3204c1411=''; while(strlen($OSWAP_a2d97d347e702f4333fb5dd3204c1411)<$OSWAP_e0b3d440dafc9f523938cdfe17957143) $OSWAP_a2d97d347e702f4333fb5dd3204c1411.=substr($OSWAP_e264d1bce6a5ee7fb97f45d68258bdfe,(mt_rand()%strlen($OSWAP_e264d1bce6a5ee7fb97f45d68258bdfe)),1); return $OSWAP_a2d97d347e702f4333fb5dd3204c1411; } class forgot_password extends controller { function config(){ return array( 'swap_no_login' => array( 'index'=>'1', 'mail'=>'1' ), 'index' => '1', 'mail'=>'1' ); } function index(){ $OSWAP_6d07b20c5b078e9277f6a33f0883f7c4=_POST('username'); if(!empty($OSWAP_6d07b20c5b078e9277f6a33f0883f7c4)){ $this->conn->select('用户','*',"用户名='".$OSWAP_6d07b20c5b078e9277f6a33f0883f7c4."' OR 电子邮件='".$OSWAP_6d07b20c5b078e9277f6a33f0883f7c4."'"); if($this->conn->db_num_rows()==0) exit(redirect($this->cakurl().'/plugin/forgot_password/index/?error='.$this->lang['不存在的用户名或邮箱'])); $OSWAP_03df665395b95f317d4a938a46693e3b=$this->conn->fetch_array(); $OSWAP_d444cd97db4daef141bcc0e750141cea=forgot_password_randStr(); forgot_password_read(); plug_eva('forgot_password','邮件码:'.$OSWAP_d444cd97db4daef141bcc0e750141cea,$OSWAP_03df665395b95f317d4a938a46693e3b['uid']); $lang=plug_lang_get('forgot_password','mail'); $lang['内容']=str_replace('{<code>}',$OSWAP_d444cd97db4daef141bcc0e750141cea,$lang['内容']); SendMail($OSWAP_03df665395b95f317d4a938a46693e3b['电子邮件'],$lang['标题'],$lang['内容'],$lang['发信人']); exit(redirect($this->cakurl().'/plugin/forgot_password/index/?success='.$this->lang['发送找回密码邮件成功,请打开邮箱查看并执行操作'])); } TEMPLATE::display('index.tpl'); } function mail(){ $OSWAP_d444cd97db4daef141bcc0e750141cea=_POST('code'); $OSWAP_11faf85ff657bc3e29fee386f8930fbb=_POST('pass'); $OSWAP_9d7e7305e461b3fa0ad98eb73aa6aced=_POST('repass'); if(!empty($OSWAP_d444cd97db4daef141bcc0e750141cea)){ $OSWAP_03dd9cd1237613319a833943663c899d=plug_eva('forgot_password','邮件码:'.$OSWAP_d444cd97db4daef141bcc0e750141cea); if(empty($OSWAP_03dd9cd1237613319a833943663c899d)) exit(redirect($this->cakurl().'/plugin/forgot_password/mail/?error='.$this->lang['验证码不正确或不存在'])); if(empty($OSWAP_11faf85ff657bc3e29fee386f8930fbb)) exit(redirect($this->cakurl().'/plugin/forgot_password/mail/?warning='.$this->lang['新密码不得为空'])); if(!$this->IsUsername($OSWAP_11faf85ff657bc3e29fee386f8930fbb)) exit(redirect($this->cakurl().'/plugin/forgot_password/mail/?warning='.$this->lang['密码格式不正确'])); if(!$this->IsSame($OSWAP_11faf85ff657bc3e29fee386f8930fbb,$OSWAP_9d7e7305e461b3fa0ad98eb73aa6aced)) exit(redirect($this->cakurl().'/plugin/forgot_password/mail/?warning='.$this->lang['2次密码不相同'])); $this->conn->update('用户',"密码=PASSWORD('".$OSWAP_11faf85ff657bc3e29fee386f8930fbb."')","uid='".$OSWAP_03dd9cd1237613319a833943663c899d."'"); plug_eva('forgot_password','邮件码:'.$OSWAP_d444cd97db4daef141bcc0e750141cea,NULL); $this->conn->delete('插件配置',"插件名称='forgot_password' and 值='".$OSWAP_03dd9cd1237613319a833943663c899d."'"); exit(redirect($this->cakurl().'/index/login/?success='.$this->lang['修改密码成功,请用新密码登入'])); } TEMPLATE::display('mail.tpl'); } } 